# NodeProbe - LinuxèŠ‚ç‚¹é…ç½®æ¢æµ‹å·¥å…·

## æ¦‚è¿°

`NodeProbe` æ˜¯ä¸€ä¸ªä¸“ä¸šçš„LinuxæœåŠ¡å™¨èŠ‚ç‚¹é…ç½®ä¿¡æ¯æ”¶é›†å·¥å…·ï¼Œèƒ½å¤Ÿå…¨é¢æ¢æµ‹å’Œé‡‡é›†æœåŠ¡å™¨çš„ç¡¬ä»¶é…ç½®ã€ç³»ç»ŸçŠ¶æ€ã€è½¯ä»¶ç¯å¢ƒç­‰å…³é”®ä¿¡æ¯ã€‚è¯¥å·¥å…·ä¸ä»…èƒ½å¤Ÿæ”¶é›†é…ç½®ä¿¡æ¯ï¼Œè¿˜å…·å¤‡è‡ªåŠ¨ä¼˜åŒ–ç³»ç»Ÿè®¾ç½®çš„èƒ½åŠ›ï¼Œæ˜¯è¿ç»´äººå‘˜è¿›è¡ŒæœåŠ¡å™¨ç®¡ç†ã€èµ„äº§æ¸…ç‚¹ã€æ•…éšœæ’æŸ¥çš„å¾—åŠ›åŠ©æ‰‹ã€‚

**ç‰ˆæœ¬**: 1.0.0  
**ä½œè€…**: sunyifei@qiniu.com  
**é¡¹ç›®**: https://github.com/sunyifei83/devops-toolkit

## æ ¸å¿ƒç‰¹æ€§

- ğŸ” **å…¨é¢æ¢æµ‹**: æ·±åº¦é‡‡é›†CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œç­‰ç¡¬ä»¶ä¿¡æ¯
- ğŸš€ **è‡ªåŠ¨ä¼˜åŒ–**: æ™ºèƒ½è¯†åˆ«å¹¶è‡ªåŠ¨ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½è®¾ç½®
- ğŸ“Š **æ¸…æ™°å±•ç¤º**: æ ¼å¼åŒ–è¾“å‡ºï¼Œä¿¡æ¯å±‚æ¬¡åˆ†æ˜
- âš¡ **å¿«é€Ÿæ‰§è¡Œ**: ç§’çº§å®Œæˆå…¨éƒ¨ä¿¡æ¯é‡‡é›†
- ğŸ”§ **æ™ºèƒ½è°ƒä¼˜**: è‡ªåŠ¨è°ƒæ•´CPUæ€§èƒ½æ¨¡å¼å’Œæ—¶åŒºè®¾ç½®
- ğŸ›¡ï¸ **å†…æ ¸æ£€æŸ¥**: è‡ªåŠ¨æ£€æµ‹å¹¶åŠ è½½å¿…è¦çš„å†…æ ¸æ¨¡å—

## ä¸»è¦åŠŸèƒ½æ¨¡å—

### 1. ç³»ç»ŸåŸºç¡€ä¿¡æ¯
- **ä¸»æœºå**: æœåŠ¡å™¨æ ‡è¯†
- **ç³»ç»Ÿè´Ÿè½½**: 1/5/15åˆ†é’Ÿå¹³å‡è´Ÿè½½
- **æ—¶åŒºè®¾ç½®**: è‡ªåŠ¨æ ¡å‡†è‡³Asia/Shanghai
- **æ“ä½œç³»ç»Ÿ**: å‘è¡Œç‰ˆå’Œç‰ˆæœ¬ä¿¡æ¯
- **å†…æ ¸ç‰ˆæœ¬**: Linuxå†…æ ¸ç‰ˆæœ¬

### 2. CPUä¿¡æ¯é‡‡é›†
- **CPUå‹å·**: å¤„ç†å™¨å…·ä½“å‹å·
- **æ ¸å¿ƒæ•°é‡**: ç‰©ç†å’Œé€»è¾‘æ ¸å¿ƒæ•°
- **è¿è¡Œæ¨¡å¼**: 32ä½/64ä½æ”¯æŒ
- **æ€§èƒ½æ¨¡å¼**: è‡ªåŠ¨ä¼˜åŒ–è‡³æœ€å¤§æ€§èƒ½
  - powersave â†’ performance è‡ªåŠ¨åˆ‡æ¢
  - æ”¯æŒå¤šç§è°ƒåº¦å™¨æ¨¡å¼

### 3. å†…å­˜é…ç½®
- **æ€»å®¹é‡**: ç³»ç»Ÿæ€»å†…å­˜å¤§å°
- **æ’æ§½ä¿¡æ¯**: å†…å­˜æ¡æ•°é‡å’Œå®¹é‡
- **å†…å­˜ç±»å‹**: DDR3/DDR4ç­‰è§„æ ¼

### 4. å­˜å‚¨ç³»ç»Ÿ
- **ç³»ç»Ÿç›˜**: æ ¹åˆ†åŒºä½¿ç”¨æƒ…å†µ
- **æ•°æ®ç›˜**: è‡ªåŠ¨è¯†åˆ«å¤§å®¹é‡æ•°æ®ç›˜
- **ç£ç›˜ç»Ÿè®¡**: æ€»ç£ç›˜æ•°å’Œæ•°æ®ç›˜æ•°é‡

### 5. ç½‘ç»œé…ç½®
- **æ¥å£åˆ—è¡¨**: æ‰€æœ‰ç½‘ç»œæ¥å£
- **æ¥å£çŠ¶æ€**: UP/DOWNçŠ¶æ€
- **ä¼ è¾“é€Ÿç‡**: ç½‘å¡é€Ÿåº¦ï¼ˆéœ€è¦ethtoolï¼‰
- **IPåœ°å€**: å„æ¥å£IPé…ç½®

### 6. è½¯ä»¶ç¯å¢ƒ
- **Python**: ç‰ˆæœ¬å’Œå®‰è£…è·¯å¾„
- **Java**: JDK/JREç‰ˆæœ¬å’ŒJAVA_HOME
- **å†…æ ¸æ¨¡å—**: nf_conntrackã€br_netfilterç­‰

### 7. è‡ªåŠ¨ä¼˜åŒ–åŠŸèƒ½
- **CPUæ€§èƒ½ä¼˜åŒ–**: è‡ªåŠ¨åˆ‡æ¢è‡³performanceæ¨¡å¼
- **æ—¶åŒºæ ¡å‡†**: è‡ªåŠ¨è®¾ç½®ä¸ºAsia/Shanghai
- **å†…æ ¸æ¨¡å—åŠ è½½**: è‡ªåŠ¨åŠ è½½å¿…è¦æ¨¡å—

## å®‰è£…éƒ¨ç½²

### ç³»ç»Ÿè¦æ±‚
- Linuxæ“ä½œç³»ç»Ÿï¼ˆCentOSã€Ubuntuã€Debianç­‰ï¼‰
- Go 1.15æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆç¼–è¯‘æ—¶éœ€è¦ï¼‰

### ä¾èµ–å·¥å…·
```bash
# åŸºç¡€å·¥å…·ï¼ˆé€šå¸¸å·²é¢„è£…ï¼‰
- /procæ–‡ä»¶ç³»ç»Ÿ
- ipå‘½ä»¤ï¼ˆiproute2åŒ…ï¼‰
- lsblkå‘½ä»¤

# å¯é€‰å·¥å…·ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰
- dmidecode  # å†…å­˜è¯¦ç»†ä¿¡æ¯
- ethtool    # ç½‘å¡é€Ÿåº¦ä¿¡æ¯
- lscpu      # CPUè¯¦ç»†ä¿¡æ¯
```

### ç¼–è¯‘å®‰è£…

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/sunyifei83/devops-toolkit.git
cd devops-toolkit/tools/go

# 2. ç¼–è¯‘NodeProbe
go build -o nodeprobe NodeProbe.go

# 3. è®¾ç½®æ‰§è¡Œæƒé™
chmod +x nodeprobe

# 4. (å¯é€‰) ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„
sudo mv nodeprobe /usr/local/bin/

# 5. éªŒè¯å®‰è£…
nodeprobe
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# æ™®é€šç”¨æˆ·è¿è¡Œï¼ˆéƒ¨åˆ†åŠŸèƒ½å—é™ï¼‰
./nodeprobe

# æ¨èï¼šä½¿ç”¨rootæƒé™è¿è¡Œï¼ˆå®Œæ•´åŠŸèƒ½ï¼‰
sudo nodeprobe
```

### æƒé™è¯´æ˜

#### æ™®é€šç”¨æˆ·æƒé™
- âœ… åŸºç¡€ç³»ç»Ÿä¿¡æ¯
- âœ… CPUåŸºæœ¬ä¿¡æ¯
- âœ… å†…å­˜æ€»é‡
- âœ… ç£ç›˜åˆ—è¡¨
- âœ… ç½‘ç»œæ¥å£ä¿¡æ¯
- âŒ å†…å­˜æ’æ§½è¯¦æƒ…ï¼ˆéœ€è¦dmidecodeï¼‰
- âŒ CPUæ€§èƒ½æ¨¡å¼è°ƒæ•´
- âŒ æ—¶åŒºè‡ªåŠ¨æ ¡å‡†
- âŒ å†…æ ¸æ¨¡å—åŠ è½½

#### Rootæƒé™
- âœ… æ‰€æœ‰ä¿¡æ¯å®Œæ•´é‡‡é›†
- âœ… è‡ªåŠ¨ä¼˜åŒ–CPUæ€§èƒ½æ¨¡å¼
- âœ… è‡ªåŠ¨æ ¡å‡†ç³»ç»Ÿæ—¶åŒº
- âœ… è‡ªåŠ¨åŠ è½½å†…æ ¸æ¨¡å—
- âœ… å†…å­˜ç¡¬ä»¶è¯¦ç»†ä¿¡æ¯

## è¾“å‡ºç¤ºä¾‹

```
NodeProbe v1.0.0 - LinuxèŠ‚ç‚¹é…ç½®æ¢æµ‹å·¥å…·
==================================================================

æ­£åœ¨æ¢æµ‹èŠ‚ç‚¹é…ç½®ä¿¡æ¯...

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ ä¸»æœºå:              prod-server-01                           â•‘
â•‘ ç³»ç»Ÿè´Ÿè½½:            0.15 0.12 0.10                          â•‘
â•‘ æ—¶åŒº:                å·²æ ¡å‡†è‡³ Asia/Shanghai (åŸ: UTC)         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ æ“ä½œç³»ç»Ÿ:            CentOS Linux 7.9.2009 (Core)            â•‘
â•‘ å†…æ ¸ç‰ˆæœ¬:            3.10.0-1160.71.1.el7.x86_64             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ CPUå‹å·:             Intel(R) Xeon(R) CPU E5-2680 v4 @ 2.40GHzâ•‘
â•‘ CPUæ ¸å¿ƒæ•°:           32                                       â•‘
â•‘ CPUè¿è¡Œæ¨¡å¼:         32-bit, 64-bit                          â•‘
â•‘ CPUæ€§èƒ½æ¨¡å¼:         å·²è‡ªåŠ¨è°ƒæ•´è‡³æœ€å¤§æ€§èƒ½æ¨¡å¼ (åŸ: powersave)  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ æ€»å†…å­˜:              62.79 GB                                 â•‘
â•‘ å†…å­˜æ’æ§½:            4ä¸ªæ’æ§½å·²ä½¿ç”¨                            â•‘
â•‘   æ’æ§½1: 16384 MB                                            â•‘
â•‘   æ’æ§½2: 16384 MB                                            â•‘
â•‘   æ’æ§½3: 16384 MB                                            â•‘
â•‘   æ’æ§½4: 16384 MB                                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ç³»ç»Ÿç›˜:              /dev/sda1 45G/200G (23%)                â•‘
â•‘ ç£ç›˜æ•°é‡:            æ€»è®¡: 5, æ•°æ®ç›˜: 4                       â•‘
â•‘ æ•°æ®ç›˜:              /dev/sdb 2.0T                           â•‘
â•‘                      /dev/sdc 2.0T                           â•‘
â•‘                      /dev/sdd 4.0T                           â•‘
â•‘                      /dev/sde 4.0T                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ç½‘ç»œæ¥å£æ•°:          3                                        â•‘
â•‘   eth0 [UP] 1000Mb/s 192.168.1.100/24                        â•‘
â•‘   eth1 [UP] 10000Mb/s 10.0.0.50/24                          â•‘
â•‘   docker0 [UP] Unknown 172.17.0.1/16                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Pythonç‰ˆæœ¬:          Python 3.6.8                            â•‘
â•‘ Pythonè·¯å¾„:          /usr/bin/python3                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Javaç‰ˆæœ¬:            Java 1.8.0_292                          â•‘
â•‘ Javaè·¯å¾„:            /usr/bin/java (JAVA_HOME: /usr/java/jdk)â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ å†…æ ¸æ¨¡å—çŠ¶æ€:        nf_conntrack: å·²è‡ªåŠ¨åŠ è½½,                â•‘
â•‘                      br_netfilter: å·²è‡ªåŠ¨åŠ è½½                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç”± NodeProbe ç”Ÿæˆ | https://github.com/sunyifei83/devops-toolkit
```

## è‡ªåŠ¨ä¼˜åŒ–è¯¦è§£

### CPUæ€§èƒ½æ¨¡å¼ä¼˜åŒ–

NodeProbeä¼šè‡ªåŠ¨æ£€æµ‹CPUè°ƒåº¦å™¨æ¨¡å¼ï¼Œå¹¶åœ¨rootæƒé™ä¸‹è‡ªåŠ¨ä¼˜åŒ–ï¼š

| æ¨¡å¼ | è¯´æ˜ | è‡ªåŠ¨å¤„ç† |
|------|------|----------|
| powersave | çœç”µæ¨¡å¼ï¼Œé™ä½æ€§èƒ½ | âœ… è‡ªåŠ¨åˆ‡æ¢åˆ°performance |
| performance | æœ€å¤§æ€§èƒ½æ¨¡å¼ | ä¿æŒä¸å˜ |
| ondemand | æŒ‰éœ€è°ƒèŠ‚ | ä¿æŒä¸å˜ |
| conservative | ä¿å®ˆè°ƒèŠ‚ | ä¿æŒä¸å˜ |
| schedutil | è°ƒåº¦å™¨æ§åˆ¶ | ä¿æŒä¸å˜ |

### æ—¶åŒºæ ¡å‡†

è‡ªåŠ¨æ£€æµ‹å¹¶æ ¡å‡†ç³»ç»Ÿæ—¶åŒºï¼š
- ç›®æ ‡æ—¶åŒºï¼šAsia/Shanghai
- æ£€æµ‹æ–¹å¼ï¼štimedatectlã€/etc/timezoneã€/etc/localtime
- è‡ªåŠ¨æ ¡å‡†ï¼šéœ€è¦rootæƒé™

### å†…æ ¸æ¨¡å—ç®¡ç†

è‡ªåŠ¨æ£€æµ‹å¹¶åŠ è½½é‡è¦å†…æ ¸æ¨¡å—ï¼š

| æ¨¡å— | ç”¨é€” | è‡ªåŠ¨åŠ è½½ |
|------|------|----------|
| nf_conntrack | è¿æ¥è·Ÿè¸ªï¼Œé˜²ç«å¢™å¿…éœ€ | âœ… |
| br_netfilter | ç½‘æ¡¥è¿‡æ»¤ï¼Œå®¹å™¨ç½‘ç»œå¿…éœ€ | âœ… |

## ä¿¡æ¯é‡‡é›†æ¥æº

| ä¿¡æ¯ç±»å‹ | æ•°æ®æ¥æº | å¤‡æ³¨ |
|----------|---------|------|
| ä¸»æœºå | /etc/hostname | ç³»ç»Ÿä¸»æœºå |
| ç³»ç»Ÿè´Ÿè½½ | /proc/loadavg | å®æ—¶è´Ÿè½½ |
| æ“ä½œç³»ç»Ÿ | /etc/os-release | å‘è¡Œç‰ˆä¿¡æ¯ |
| å†…æ ¸ç‰ˆæœ¬ | /proc/version | å†…æ ¸ä¿¡æ¯ |
| CPUä¿¡æ¯ | /proc/cpuinfo | å¤„ç†å™¨è¯¦æƒ… |
| å†…å­˜æ€»é‡ | /proc/meminfo | å†…å­˜ç»Ÿè®¡ |
| å†…å­˜æ’æ§½ | dmidecode -t 17 | éœ€è¦root |
| ç£ç›˜ä¿¡æ¯ | lsblkã€df | å­˜å‚¨è®¾å¤‡ |
| ç½‘ç»œæ¥å£ | ip addr | ç½‘ç»œé…ç½® |
| ç½‘å¡é€Ÿåº¦ | ethtool | å¯é€‰å·¥å…· |

## æœ€ä½³å®è·µ

### æœåŠ¡å™¨åŸºçº¿å»ºç«‹
```bash
# æ”¶é›†æ–°æœåŠ¡å™¨é…ç½®åŸºçº¿
sudo nodeprobe > server_baseline_$(hostname)_$(date +%Y%m%d).txt
```

### æ‰¹é‡èŠ‚ç‚¹ä¿¡æ¯æ”¶é›†
```bash
# ä½¿ç”¨è„šæœ¬æ‰¹é‡æ”¶é›†
for host in server1 server2 server3; do
    ssh root@$host 'nodeprobe' > ${host}_info.txt
done
```

### é…ç½®å˜æ›´å¯¹æ¯”
```bash
# æ”¶é›†å½“å‰é…ç½®
sudo nodeprobe > current_config.txt

# ä¸åŸºçº¿å¯¹æ¯”
diff baseline_config.txt current_config.txt
```

### è‡ªåŠ¨åŒ–å·¡æ£€
```bash
# æ·»åŠ åˆ°crontabå®šæœŸæ‰§è¡Œ
0 9 * * * /usr/local/bin/nodeprobe > /var/log/nodeprobe/$(date +\%Y\%m\%d).log
```

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **éƒ¨åˆ†ä¿¡æ¯æ˜¾ç¤ºä¸º"Unknown"æˆ–"N/A"**
   - åŸå› ï¼šæƒé™ä¸è¶³æˆ–ç¼ºå°‘ç›¸å…³å·¥å…·
   - è§£å†³ï¼šä½¿ç”¨sudoè¿è¡Œï¼Œå®‰è£…dmidecodeã€ethtoolç­‰å·¥å…·

2. **CPUæ€§èƒ½æ¨¡å¼æ— æ³•è‡ªåŠ¨è°ƒæ•´**
   - åŸå› ï¼šéœ€è¦rootæƒé™æˆ–ç³»ç»Ÿä¸æ”¯æŒ
   - è§£å†³ï¼š`sudo nodeprobe`

3. **å†…å­˜æ’æ§½ä¿¡æ¯ä¸ºç©º**
   - åŸå› ï¼šdmidecodeæœªå®‰è£…æˆ–æƒé™ä¸è¶³
   - è§£å†³ï¼š
   ```bash
   # CentOS/RHEL
   sudo yum install -y dmidecode
   
   # Ubuntu/Debian
   sudo apt-get install -y dmidecode
   ```

4. **ç½‘å¡é€Ÿåº¦æ˜¾ç¤ºUnknown**
   - åŸå› ï¼šethtoolæœªå®‰è£…
   - è§£å†³ï¼š
   ```bash
   # CentOS/RHEL
   sudo yum install -y ethtool
   
   # Ubuntu/Debian
   sudo apt-get install -y ethtool
   ```

## æ‰©å±•å¼€å‘

### æœªæ¥åŠŸèƒ½è§„åˆ’

1. **è¿œç¨‹èŠ‚ç‚¹é‡‡é›†**
   ```bash
   nodeprobe --remote host1,host2,host3
   ```

2. **å¤šæ ¼å¼è¾“å‡º**
   ```bash
   nodeprobe --format json > config.json
   nodeprobe --format yaml > config.yaml
   ```

3. **ç¡¬ä»¶åŸºå‡†æµ‹è¯•**
   ```bash
   nodeprobe --benchmark cpu
   nodeprobe --benchmark memory
   nodeprobe --benchmark disk
   ```

4. **é…ç½®å¯¹æ¯”**
   ```bash
   nodeprobe --compare baseline.txt
   ```

5. **Webç•Œé¢**
   - é›†ä¸­ç®¡ç†å¤šèŠ‚ç‚¹
   - å†å²æ•°æ®å±•ç¤º
   - é…ç½®å˜æ›´è¿½è¸ª

## ä¸PerfSnapé…åˆä½¿ç”¨

NodeProbeå’ŒPerfSnapæ˜¯é…å¥—çš„æœåŠ¡å™¨ç®¡ç†å·¥å…·ï¼Œå…±åŒæ„æˆå®Œæ•´çš„æœåŠ¡å™¨çŠ¶æ€åˆ†æè§£å†³æ–¹æ¡ˆï¼š

| å·¥å…· | å®šä½ | æ•°æ®ç±»å‹ | ä½¿ç”¨åœºæ™¯ | æ‰§è¡Œé¢‘ç‡ |
|------|------|---------|----------|----------|
| NodeProbe | é…ç½®æ¢æµ‹ | é™æ€ä¿¡æ¯ | èµ„äº§ç®¡ç†ã€é…ç½®å®¡è®¡ã€ç¯å¢ƒå‡†å¤‡ | ä½é¢‘ï¼ˆé…ç½®å˜æ›´æ—¶ï¼‰ |
| PerfSnap | æ€§èƒ½åˆ†æ | åŠ¨æ€æ•°æ® | æ€§èƒ½ç›‘æ§ã€æ•…éšœè¯Šæ–­ã€è´Ÿè½½åˆ†æ | é«˜é¢‘ï¼ˆå®æ—¶ç›‘æ§ï¼‰ |

### ç»„åˆä½¿ç”¨ç¤ºä¾‹

#### 1. æ–°æœåŠ¡å™¨ä¸Šçº¿æ£€æŸ¥

```bash
#!/bin/bash
# æ–°æœåŠ¡å™¨å®Œæ•´æ£€æŸ¥è„šæœ¬

echo "========== æœåŠ¡å™¨ä¸Šçº¿æ£€æŸ¥ =========="
echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
echo "ä¸»æœº: $(hostname)"
echo ""

# Step 1: æ”¶é›†ç¡¬ä»¶é…ç½®
echo ">>> 1. æ£€æŸ¥ç¡¬ä»¶é…ç½®å’Œç³»ç»Ÿè®¾ç½®..."
sudo nodeprobe > nodeprobe_$(hostname)_$(date +%Y%m%d).txt
echo "é…ç½®ä¿¡æ¯å·²ä¿å­˜"

# Step 2: æ£€æŸ¥æ€§èƒ½åŸºçº¿
echo ">>> 2. å»ºç«‹æ€§èƒ½åŸºçº¿..."
sudo perfsnap > perfsnap_baseline_$(hostname)_$(date +%Y%m%d).txt
echo "æ€§èƒ½åŸºçº¿å·²å»ºç«‹"

# Step 3: ç®€å•å‹åŠ›æµ‹è¯•åçš„æ€§èƒ½æ£€æŸ¥
echo ">>> 3. æ‰§è¡Œå‹åŠ›æµ‹è¯•..."
stress --cpu 4 --timeout 30s 2>/dev/null || echo "è·³è¿‡å‹åŠ›æµ‹è¯•"

echo ">>> 4. å‹åŠ›æµ‹è¯•åæ€§èƒ½æ£€æŸ¥..."
sudo perfsnap > perfsnap_stress_$(hostname)_$(date +%Y%m%d).txt

echo ""
echo "æ£€æŸ¥å®Œæˆï¼ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶ï¼š"
ls -lh *.txt | tail -3
```

#### 2. æ•…éšœè¯Šæ–­æµç¨‹

```bash
#!/bin/bash
# æ•…éšœè¯Šæ–­ç»„åˆè„šæœ¬

REPORT_DIR="/var/log/diagnostics/$(date +%Y%m%d_%H%M%S)"
mkdir -p $REPORT_DIR

echo "å¼€å§‹æ•…éšœè¯Šæ–­..."

# 1. å…ˆæ£€æŸ¥é…ç½®æ˜¯å¦æœ‰å˜æ›´
echo "[1/4] æ£€æŸ¥ç³»ç»Ÿé…ç½®..."
sudo nodeprobe > $REPORT_DIR/01_nodeprobe.txt

# 2. è·å–å½“å‰æ€§èƒ½å¿«ç…§
echo "[2/4] è·å–æ€§èƒ½å¿«ç…§..."
sudo perfsnap > $REPORT_DIR/02_perfsnap_current.txt

# 3. æŒç»­ç›‘æ§æ€§èƒ½ï¼ˆ1åˆ†é’Ÿï¼‰
echo "[3/4] å¼€å§‹å®æ—¶ç›‘æ§ï¼ˆ60ç§’ï¼‰..."
sudo perfsnap -m 2 60 > $REPORT_DIR/03_perfsnap_monitor.txt

# 4. æ”¶é›†ç³»ç»Ÿæ—¥å¿—
echo "[4/4] æ”¶é›†ç³»ç»Ÿæ—¥å¿—..."
tail -n 1000 /var/log/messages > $REPORT_DIR/04_system_logs.txt 2>/dev/null
dmesg -T | tail -n 500 > $REPORT_DIR/05_dmesg.txt

# ç”Ÿæˆè¯Šæ–­æ‘˜è¦
cat > $REPORT_DIR/00_summary.txt << EOF
æ•…éšœè¯Šæ–­æŠ¥å‘Š
ç”Ÿæˆæ—¶é—´: $(date)
ä¸»æœºå: $(hostname)

æ–‡ä»¶åˆ—è¡¨:
- 01_nodeprobe.txt: ç³»ç»Ÿé…ç½®ä¿¡æ¯
- 02_perfsnap_current.txt: å½“å‰æ€§èƒ½çŠ¶æ€
- 03_perfsnap_monitor.txt: 60ç§’æ€§èƒ½ç›‘æ§
- 04_system_logs.txt: ç³»ç»Ÿæ—¥å¿—
- 05_dmesg.txt: å†…æ ¸æ—¥å¿—

å¿«é€Ÿæ£€æŸ¥é¡¹:
$(grep "CPUæ€§èƒ½æ¨¡å¼" $REPORT_DIR/01_nodeprobe.txt)
$(grep "ç³»ç»Ÿè´Ÿè½½" $REPORT_DIR/02_perfsnap_current.txt | head -1)
$(grep "å†…å­˜ä½¿ç”¨ç‡" $REPORT_DIR/02_perfsnap_current.txt | head -1)
EOF

echo ""
echo "è¯Šæ–­å®Œæˆï¼æŠ¥å‘Šä¿å­˜åœ¨: $REPORT_DIR"
echo "æŸ¥çœ‹æ‘˜è¦: cat $REPORT_DIR/00_summary.txt"
```

#### 3. æ—¥å¸¸å·¡æ£€è„šæœ¬

```bash
#!/bin/bash
# daily_inspection.sh - æ—¥å¸¸å·¡æ£€è„šæœ¬

INSPECTION_LOG="/var/log/inspection/$(date +%Y%m%d).log"
mkdir -p $(dirname $INSPECTION_LOG)

{
    echo "====== æ—¥å¸¸å·¡æ£€æŠ¥å‘Š ======"
    echo "æ—¥æœŸ: $(date '+%Y-%m-%d %H:%M:%S')"
    echo ""
    
    # åŸºç¡€é…ç½®æ£€æŸ¥ï¼ˆæ¯å¤©ä¸€æ¬¡ï¼‰
    echo "=== é…ç½®ä¿¡æ¯ ==="
    sudo nodeprobe | grep -E "ä¸»æœºå:|CPUæ ¸å¿ƒæ•°:|æ€»å†…å­˜:|ç£ç›˜æ•°é‡:|ç½‘ç»œæ¥å£æ•°:"
    
    echo ""
    echo "=== æ€§èƒ½çŠ¶æ€ ==="
    sudo perfsnap | grep -E "ç³»ç»Ÿè´Ÿè½½:|CPUä½¿ç”¨ç‡:|å†…å­˜:|ç£ç›˜ .* åˆ©ç”¨ç‡|TCPè¿æ¥:"
    
    echo ""
    echo "=== å¼‚å¸¸æ£€æŸ¥ ==="
    # æ£€æŸ¥æ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜
    sudo perfsnap | grep "âš ï¸" || echo "âœ… æ— æ€§èƒ½å‘Šè­¦"
    
} | tee $INSPECTION_LOG

# å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœé…ç½®äº†é‚®ä»¶ï¼‰
# mail -s "æœåŠ¡å™¨å·¡æ£€æŠ¥å‘Š $(hostname) $(date +%Y%m%d)" admin@example.com < $INSPECTION_LOG
```

#### 4. æ€§èƒ½å¯¹æ¯”åˆ†æ

```bash
#!/bin/bash
# æ€§èƒ½å˜åŒ–å¯¹æ¯”åˆ†æ

echo "=== é…ç½®ä¸æ€§èƒ½å¯¹æ¯”åˆ†æ ==="

# æ”¶é›†å½“å‰çŠ¶æ€
TEMP_DIR=$(mktemp -d)
sudo nodeprobe > $TEMP_DIR/config_now.txt
sudo perfsnap > $TEMP_DIR/perf_now.txt

# ä¸åŸºçº¿å¯¹æ¯”ï¼ˆå‡è®¾æœ‰åŸºçº¿æ–‡ä»¶ï¼‰
BASELINE_DIR="/opt/baseline"

if [ -f "$BASELINE_DIR/nodeprobe_baseline.txt" ]; then
    echo ">>> é…ç½®å˜æ›´ï¼š"
    diff -u $BASELINE_DIR/nodeprobe_baseline.txt $TEMP_DIR/config_now.txt | \
        grep "^[+-]" | grep -v "^[+-][+-][+-]" | head -20
else
    echo "æœªæ‰¾åˆ°é…ç½®åŸºçº¿æ–‡ä»¶"
fi

if [ -f "$BASELINE_DIR/perfsnap_baseline.txt" ]; then
    echo ""
    echo ">>> æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”ï¼š"
    # æå–å…³é”®æŒ‡æ ‡è¿›è¡Œå¯¹æ¯”
    for metric in "ç³»ç»Ÿè´Ÿè½½" "CPUä½¿ç”¨ç‡" "å†…å­˜" "ç£ç›˜.*åˆ©ç”¨ç‡"; do
        echo "- $metric:"
        echo "  åŸºçº¿: $(grep "$metric" $BASELINE_DIR/perfsnap_baseline.txt | head -1)"
        echo "  å½“å‰: $(grep "$metric" $TEMP_DIR/perf_now.txt | head -1)"
    done
else
    echo "æœªæ‰¾åˆ°æ€§èƒ½åŸºçº¿æ–‡ä»¶"
fi

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf $TEMP_DIR
```

#### 5. æ‰¹é‡æœåŠ¡å™¨æ£€æŸ¥

```bash
#!/bin/bash
# æ‰¹é‡æ£€æŸ¥å¤šå°æœåŠ¡å™¨

SERVERS="server1 server2 server3 server4"
REPORT_DIR="cluster_report_$(date +%Y%m%d_%H%M%S)"
mkdir -p $REPORT_DIR

echo "å¼€å§‹æ‰¹é‡æ£€æŸ¥æœåŠ¡å™¨é›†ç¾¤..."

for server in $SERVERS; do
    echo ">>> æ£€æŸ¥ $server ..."
    
    # å¹¶è¡Œæ‰§è¡Œé…ç½®å’Œæ€§èƒ½æ£€æŸ¥
    ssh root@$server "sudo nodeprobe" > $REPORT_DIR/${server}_nodeprobe.txt 2>&1 &
    ssh root@$server "sudo perfsnap" > $REPORT_DIR/${server}_perfsnap.txt 2>&1 &
done

# ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
wait

# ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
cat > $REPORT_DIR/00_cluster_summary.md << EOF
# é›†ç¾¤æ£€æŸ¥æŠ¥å‘Š

ç”Ÿæˆæ—¶é—´: $(date)

## æœåŠ¡å™¨åˆ—è¡¨
$(for s in $SERVERS; do echo "- $s"; done)

## é…ç½®æ±‡æ€»

| æœåŠ¡å™¨ | CPUæ ¸å¿ƒ | å†…å­˜ | ç£ç›˜æ•° | çŠ¶æ€ |
|--------|---------|------|--------|------|
$(for server in $SERVERS; do
    if [ -f "$REPORT_DIR/${server}_nodeprobe.txt" ]; then
        cpu=$(grep "CPUæ ¸å¿ƒæ•°:" $REPORT_DIR/${server}_nodeprobe.txt | awk '{print $2}')
        mem=$(grep "æ€»å†…å­˜:" $REPORT_DIR/${server}_nodeprobe.txt | awk '{print $2, $3}')
        disk=$(grep "ç£ç›˜æ•°é‡:" $REPORT_DIR/${server}_nodeprobe.txt | awk -F'æ€»è®¡:' '{print $2}' | awk '{print $1}')
        echo "| $server | $cpu | $mem | $disk | âœ… |"
    else
        echo "| $server | - | - | - | âŒ |"
    fi
done)

## æ€§èƒ½çŠ¶æ€

| æœåŠ¡å™¨ | è´Ÿè½½ | CPUä½¿ç”¨ | å†…å­˜ä½¿ç”¨ | å‘Šè­¦ |
|--------|------|---------|----------|------|
$(for server in $SERVERS; do
    if [ -f "$REPORT_DIR/${server}_perfsnap.txt" ]; then
        load=$(grep "ç³»ç»Ÿè´Ÿè½½:" $REPORT_DIR/${server}_perfsnap.txt | head -1 | awk -F': ' '{print $2}' | awk '{print $1}')
        cpu=$(grep "CPUä½¿ç”¨ç‡:" $REPORT_DIR/${server}_perfsnap.txt | grep -oE '[0-9]+%' | head -1)
        mem=$(grep "å†…å­˜:" $REPORT_DIR/${server}_perfsnap.txt | grep -oE '[0-9.]+%' | head -1)
        alerts=$(grep -c "âš ï¸" $REPORT_DIR/${server}_perfsnap.txt)
        echo "| $server | $load | $cpu | $mem | $alerts |"
    else
        echo "| $server | - | - | - | - |"
    fi
done)

## è¯¦ç»†æŠ¥å‘Š
$(for server in $SERVERS; do
    echo "- [$server NodeProbe]($REPORT_DIR/${server}_nodeprobe.txt)"
    echo "- [$server PerfSnap]($REPORT_DIR/${server}_perfsnap.txt)"
done)
EOF

echo ""
echo "æ‰¹é‡æ£€æŸ¥å®Œæˆï¼"
echo "æŸ¥çœ‹æ±‡æ€»æŠ¥å‘Š: cat $REPORT_DIR/00_cluster_summary.md"
```

#### 6. è‡ªåŠ¨åŒ–è¿ç»´é›†æˆ

```bash
#!/bin/bash
# é›†æˆåˆ°è‡ªåŠ¨åŒ–è¿ç»´æµç¨‹

# æ·»åŠ åˆ°crontabçš„å®šæ—¶ä»»åŠ¡
cat << 'EOF' > /etc/cron.d/server-inspection
# æ¯å¤©æ—©ä¸Š9ç‚¹æ‰§è¡Œé…ç½®æ£€æŸ¥
0 9 * * * root /usr/local/bin/nodeprobe > /var/log/nodeprobe/$(date +\%Y\%m\%d).log 2>&1

# æ¯å°æ—¶æ‰§è¡Œæ€§èƒ½å¿«ç…§
0 * * * * root /usr/local/bin/perfsnap > /var/log/perfsnap/$(date +\%Y\%m\%d_\%H).log 2>&1

# æ¯å‘¨ä¸€ç”Ÿæˆå‘¨æŠ¥
0 10 * * 1 root /usr/local/bin/weekly_report.sh

# æ€§èƒ½å‘Šè­¦æ£€æŸ¥ï¼ˆæ¯5åˆ†é’Ÿï¼‰
*/5 * * * * root /usr/local/bin/perfsnap | grep -q "âš ï¸" && /usr/local/bin/send_alert.sh
EOF

# weekly_report.sh - å‘¨æŠ¥ç”Ÿæˆè„šæœ¬
cat << 'EOF' > /usr/local/bin/weekly_report.sh
#!/bin/bash
REPORT_FILE="/var/reports/weekly_$(date +%Y%W).html"

{
    echo "<html><head><title>æœåŠ¡å™¨å‘¨æŠ¥</title></head><body>"
    echo "<h1>æœåŠ¡å™¨è¿è¡Œå‘¨æŠ¥</h1>"
    echo "<p>ç”Ÿæˆæ—¶é—´: $(date)</p>"
    
    echo "<h2>1. é…ç½®ä¿¡æ¯</h2>"
    echo "<pre>"
    sudo nodeprobe
    echo "</pre>"
    
    echo "<h2>2. æœ¬å‘¨æ€§èƒ½è¶‹åŠ¿</h2>"
    echo "<pre>"
    for day in $(seq 0 6); do
        date -d "$day days ago" +%Y%m%d
        grep "ç³»ç»Ÿè´Ÿè½½\|CPUä½¿ç”¨ç‡\|å†…å­˜" /var/log/perfsnap/$(date -d "$day days ago" +%Y%m%d)*.log | head -3
        echo "---"
    done
    echo "</pre>"
    
    echo "<h2>3. å‘Šè­¦ç»Ÿè®¡</h2>"
    echo "<pre>"
    grep -h "âš ï¸" /var/log/perfsnap/*.log | sort | uniq -c | sort -rn
    echo "</pre>"
    
    echo "</body></html>"
} > $REPORT_FILE

# å‘é€å‘¨æŠ¥
# mail -s "$(hostname) æœåŠ¡å™¨å‘¨æŠ¥" -a $REPORT_FILE admin@example.com < /dev/null
EOF

chmod +x /usr/local/bin/weekly_report.sh
```

### ä½¿ç”¨åœºæ™¯å¯¹ç…§è¡¨

| åœºæ™¯ | NodeProbeä½¿ç”¨ | PerfSnapä½¿ç”¨ | ç»„åˆä»·å€¼ |
|------|---------------|--------------|----------|
| **æ–°æœåŠ¡å™¨éªŒæ”¶** | âœ… éªŒè¯ç¡¬ä»¶é…ç½®æ˜¯å¦ç¬¦åˆé‡‡è´­è¦æ±‚ | âœ… å»ºç«‹æ€§èƒ½åŸºçº¿ | å®Œæ•´çš„éªŒæ”¶æŠ¥å‘Š |
| **æ•…éšœè¯Šæ–­** | âœ… æ£€æŸ¥é…ç½®æ˜¯å¦è¢«ä¿®æ”¹ | âœ… å®šä½æ€§èƒ½ç“¶é¢ˆ | å¿«é€Ÿå®šä½é—®é¢˜æ ¹æº |
| **
