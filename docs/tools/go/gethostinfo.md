# gethostinfo.go - 系统硬件信息采集工具

## 概述

`gethostinfo.go` 是一个全面的系统硬件信息采集工具，用于收集和展示Linux服务器的硬件配置、系统状态和软件环境信息。该工具具有自动优化功能，可以在root权限下自动调整系统性能参数。

**版本**: 1.0.0  
**作者**: sunyifei@qiniu.com

## 主要功能

### 1. 系统基础信息采集
- **主机名**: 获取系统主机名
- **系统负载**: 实时获取1分钟、5分钟、15分钟的系统负载
- **时区信息**: 检测当前时区，支持自动校准到Asia/Shanghai
- **操作系统**: 获取Linux发行版信息
- **内核版本**: 获取当前运行的内核版本

### 2. CPU信息
- **CPU型号**: 检测处理器具体型号
- **核心数量**: 统计CPU核心总数
- **运行模式**: 检测32位/64位运行模式
- **性能模式**: 检测CPU频率调节模式，支持自动优化
  - 自动从省电模式(powersave)切换到性能模式(performance)
  - 支持多种调节模式识别：performance、powersave、ondemand、conservative、schedutil

### 3. 内存信息
- **总内存容量**: 以GB为单位显示总内存
- **内存插槽**: 使用dmidecode获取物理内存条信息
- **插槽详情**: 显示每个插槽的内存容量

### 4. 磁盘信息
- **系统盘**: 显示根分区挂载信息、使用率
- **磁盘统计**: 统计所有磁盘数量
- **数据盘识别**: 自动识别大容量数据盘（>1TB）
- **磁盘详情**: 显示每个磁盘的设备名和容量

### 5. 网络接口
- **接口列表**: 列出所有网络接口（排除lo）
- **接口状态**: UP/DOWN状态检测
- **链路速度**: 使用ethtool获取网卡速度
- **IP地址**: 显示每个接口的IPv4地址

### 6. 软件环境
- **Python环境**: 
  - 检测Python版本（支持python3/python/python2）
  - 显示Python可执行文件路径
- **Java环境**:
  - 检测Java版本
  - 显示Java路径和JAVA_HOME环境变量

### 7. 内核模块管理
- **模块检测**: 检查关键内核模块状态
  - nf_conntrack：连接跟踪模块
  - br_netfilter：桥接网络过滤模块
- **自动加载**: root权限下自动加载缺失的内核模块

## 自动优化功能

当以root权限运行时，工具会自动执行以下优化：

1. **CPU性能优化**
   - 检测到powersave模式时自动切换到performance模式
   - 应用到所有CPU核心

2. **时区校准**
   - 非Asia/Shanghai时区自动校准
   - 使用timedatectl或直接修改系统文件

3. **内核模块加载**
   - 自动加载nf_conntrack和br_netfilter模块
   - 这些模块对容器网络和防火墙功能至关重要

## 使用方法

### 编译
```bash
# 编译成可执行文件
go build -o gethostinfo gethostinfo.go
```

### 运行
```bash
# 普通用户运行（部分功能受限）
./gethostinfo

# root权限运行（推荐，可获取完整信息并自动优化）
sudo ./gethostinfo
```

## 输出示例

```
╔════════════════════════════════════════════════════════════════╗
║ 主机名:              server-01                                   ║
║ 系统负载:            0.52 0.68 0.71                              ║
║ 时区:                Asia/Shanghai                               ║
╠════════════════════════════════════════════════════════════════╣
║ 操作系统:            Ubuntu 20.04.3 LTS                          ║
║ 内核版本:            5.4.0-91-generic                            ║
╠════════════════════════════════════════════════════════════════╣
║ CPU型号:             Intel(R) Xeon(R) CPU E5-2680 v4 @ 2.40GHz   ║
║ CPU核心数:           56                                          ║
║ CPU运行模式:         32-bit, 64-bit                              ║
║ CPU性能模式:         已自动调整至最大性能模式 (原: powersave)         ║
╠════════════════════════════════════════════════════════════════╣
║ 总内存:              125.83 GB                                   ║
║ 内存插槽:            4个插槽已使用                                 ║
║   插槽1: 32 GB                                                  ║
║   插槽2: 32 GB                                                  ║
║   插槽3: 32 GB                                                  ║
║   插槽4: 32 GB                                                  ║
╠════════════════════════════════════════════════════════════════╣
║ 系统盘:              /dev/sda2 180G/439G (42%)                   ║
║ 磁盘数量:            总计: 5, 数据盘: 4                           ║
║ 数据盘:              /dev/sdb 3.6T                               ║
║                      /dev/sdc 3.6T                               ║
║                      /dev/sdd 3.6T                               ║
║                      /dev/sde 3.6T                               ║
╠════════════════════════════════════════════════════════════════╣
║ 网络接口数:          2                                           ║
║   eth0 [UP] 10000Mb/s 192.168.1.100/24                          ║
║   eth1 [DOWN] Unknown                                           ║
╠════════════════════════════════════════════════════════════════╣
║ Python版本:          Python 3.8.10                               ║
║ Python路径:          /usr/bin/python3                            ║
╠════════════════════════════════════════════════════════════════╣
║ Java版本:            Java 11.0.11                                ║
║ Java路径:            /usr/bin/java (JAVA_HOME: /usr/lib/jvm/j... ║
╠════════════════════════════════════════════════════════════════╣
║ 内核模块状态:        nf_conntrack: 已加载, br_netfilter: 已自动加载  ║
╚════════════════════════════════════════════════════════════════╝
```

## 权限说明

### 普通用户权限
- 可以获取大部分系统信息
- 无法获取内存插槽详细信息（需要dmidecode）
- 无法自动优化CPU性能模式
- 无法自动校准时区
- 无法自动加载内核模块

### Root权限
- 获取完整的硬件信息
- 自动优化CPU性能模式
- 自动校准系统时区
- 自动加载必要的内核模块
- 访问dmidecode获取详细硬件信息

## 依赖要求

### 系统命令
- 基础命令：`hostname`, `cat`, `df`, `lsblk`
- 网络命令：`ip`, `ethtool`（可选）
- 硬件信息：`lscpu`, `dmidecode`（需要root）
- 系统管理：`timedatectl`, `modprobe`（需要root）
- 软件检测：`which`, `java`, `python`

### Go环境
- Go 1.15 或更高版本

## 技术特点

1. **纯Go实现**: 无需外部Go依赖库，仅使用标准库
2. **智能检测**: 自动识别不同Linux发行版的差异
3. **容错设计**: 命令失败时提供降级方案
4. **格式化输出**: 使用表格化展示，信息清晰易读
5. **自动优化**: root权限下自动进行系统优化

## 适用场景

- **服务器巡检**: 快速了解服务器硬件配置和状态
- **性能调优**: 自动检测并优化性能相关设置
- **环境准备**: 部署前检查和准备系统环境
- **故障诊断**: 收集系统信息用于问题排查
- **资产管理**: 批量收集服务器硬件信息
- **容器环境准备**: 自动加载容器所需的内核模块

## 注意事项

1. **操作系统兼容性**: 主要针对Linux系统设计，在其他Unix系统上可能需要调整
2. **命令依赖**: 某些功能依赖特定的系统命令，缺失时会显示"N/A"或"Unknown"
3. **性能影响**: 自动优化功能会改变系统设置，生产环境使用前请评估影响
4. **权限提示**: 非root运行时会提示部分功能受限

## TODO (未来版本计划)

1. 支持远程节点信息采集
2. 支持硬件基准测试（CPU/内存/磁盘/网络）
3. 支持输出JSON/YAML格式
4. 支持配置文件定制采集项
5. 支持Windows和macOS系统
