# PerfSnap - Linuxç³»ç»Ÿæ€§èƒ½å¿«ç…§åˆ†æå·¥å…·

## æ¦‚è¿°

`PerfSnap` æ˜¯ä¸€ä¸ªä¸“ä¸šçš„Linuxç³»ç»Ÿæ€§èƒ½å¿«ç…§åˆ†æå·¥å…·ï¼Œèƒ½å¤Ÿå¿«é€Ÿé‡‡é›†å’Œåˆ†æCPUã€å†…å­˜ã€ç£ç›˜IOã€ç½‘ç»œç­‰å…³é”®æ€§èƒ½æŒ‡æ ‡ã€‚v1.1.0ç‰ˆæœ¬æ–°å¢äº†ç«ç„°å›¾ç”ŸæˆåŠŸèƒ½ï¼Œå¯ä»¥è‡ªåŠ¨æˆ–æ‰‹åŠ¨æŒ‡å®šè¿›ç¨‹ç”ŸæˆCPUç«ç„°å›¾ï¼Œå¸®åŠ©æ·±å…¥åˆ†ææ€§èƒ½ç“¶é¢ˆã€‚

**ç‰ˆæœ¬**: 1.1.0  
**ä½œè€…**: sunyifei83@gmail.com  
**é¡¹ç›®**: https://github.com/sunyifei83/devops-toolkit  
**æ›´æ–°æ—¥æœŸ**: 2025-09-15

## æ ¸å¿ƒç‰¹æ€§

- ğŸš€ **å…¨é¢æ€§èƒ½åˆ†æ**: ä¸€é”®è·å–ç³»ç»Ÿæ€§èƒ½å…¨è²Œ
- ğŸ“Š **å¤šç»´åº¦æŒ‡æ ‡**: CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œã€è¿›ç¨‹å…¨è¦†ç›–
- âš¡ **å¿«é€Ÿè¯Šæ–­**: è‡ªåŠ¨è¯†åˆ«æ€§èƒ½é—®é¢˜å¹¶æä¾›ä¼˜åŒ–å»ºè®®
- ğŸ“ˆ **å®æ—¶ç›‘æ§**: æ”¯æŒæŒç»­ç›‘æ§æ¨¡å¼ï¼Œå®æ—¶åˆ·æ–°æ•°æ®
- ğŸ¯ **æ™ºèƒ½åˆ†æ**: è‡ªåŠ¨æ£€æµ‹å¼‚å¸¸æŒ‡æ ‡å¹¶é¢„è­¦
- ğŸ”¥ **ç«ç„°å›¾ç”Ÿæˆ**: æ”¯æŒCPUç«ç„°å›¾ç”Ÿæˆï¼Œæ·±å…¥åˆ†æçƒ­ç‚¹å‡½æ•°
- ğŸ¤– **è‡ªåŠ¨åŒ–**: å¯è‡ªåŠ¨é€‰æ‹©CPUå ç”¨æœ€é«˜çš„è¿›ç¨‹ç”Ÿæˆç«ç„°å›¾
- ğŸŒ **å¯è§†åŒ–**: ç”ŸæˆHTMLæŸ¥çœ‹å™¨ï¼Œæ–¹ä¾¿æµè§ˆç«ç„°å›¾

## ä¸»è¦åŠŸèƒ½æ¨¡å—

### 1. ç³»ç»Ÿæ¦‚å†µ
- è¿è¡Œæ—¶é—´å’Œåœ¨çº¿ç”¨æˆ·æ•°
- ç³»ç»Ÿè´Ÿè½½ï¼ˆ1/5/15åˆ†é’Ÿï¼‰
- CPUæ ¸å¿ƒæ•°å’Œè´Ÿè½½è¯„ä¼°

### 2. CPUåˆ†æ
- å¤šæ ¸CPUä½¿ç”¨ç‡è¯¦æƒ…
- ç”¨æˆ·æ€/ç³»ç»Ÿæ€/IOç­‰å¾…åˆ†æ
- ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œä¸­æ–­ç»Ÿè®¡
- é«˜CPUè¿›ç¨‹æ’è¡Œ

### 3. å†…å­˜ç›‘æ§
- å†…å­˜ä½¿ç”¨ç‡å’Œå¯ç”¨å†…å­˜
- ç¼“å­˜å’Œç¼“å†²åŒºç»Ÿè®¡
- äº¤æ¢åˆ†åŒºä½¿ç”¨æƒ…å†µ

### 4. ç£ç›˜IO
- è®¾å¤‡çº§è¯»å†™IOPS
- ååé‡ç»Ÿè®¡ï¼ˆKB/sï¼‰
- é˜Ÿåˆ—é•¿åº¦å’Œåˆ©ç”¨ç‡

### 5. ç½‘ç»œæµé‡
- æ¥å£çº§æ”¶å‘åŒ…é€Ÿç‡
- ç½‘ç»œååé‡ï¼ˆKB/sï¼‰
- TCPè¿æ¥çŠ¶æ€ç»Ÿè®¡

### 6. è¿›ç¨‹åˆ†æ
- TOPè¿›ç¨‹ï¼ˆæŒ‰CPU/å†…å­˜æ’åºï¼‰
- é«˜CPUè¿›ç¨‹è¯¦æƒ…ï¼ˆpidstatï¼‰
- è¿›ç¨‹çº§æ€§èƒ½æŒ‡æ ‡

### 7. ç«ç„°å›¾ç”Ÿæˆï¼ˆv1.1.0æ–°å¢ï¼‰
- è‡ªåŠ¨é€‰æ‹©CPUæœ€é«˜è¿›ç¨‹
- æ”¯æŒæŒ‡å®šPIDé‡‡æ ·
- å¯é…ç½®é‡‡æ ·æ—¶é•¿å’Œé¢‘ç‡
- ç”Ÿæˆäº¤äº’å¼SVGç«ç„°å›¾
- æä¾›HTMLæŸ¥çœ‹å™¨

## å®‰è£…éƒ¨ç½²

### ç³»ç»Ÿè¦æ±‚
- Linuxæ“ä½œç³»ç»Ÿï¼ˆCentOSã€Ubuntuã€Debianç­‰ï¼‰
- Go 1.15æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆç¼–è¯‘æ—¶éœ€è¦ï¼‰
- Rootæƒé™ï¼ˆæ¨èï¼Œè·å–å®Œæ•´æ•°æ®ï¼‰

### ä¾èµ–å·¥å…·

#### åŸºç¡€ä¾èµ–ï¼ˆæ€§èƒ½åˆ†æï¼‰
```bash
# CentOS/RHEL
sudo yum install -y sysstat

# Ubuntu/Debian  
sudo apt-get install -y sysstat

# éªŒè¯å®‰è£…
which sar mpstat pidstat iostat
```

#### ç«ç„°å›¾ä¾èµ–ï¼ˆå¯é€‰ï¼‰
```bash
# å®‰è£…perfå·¥å…·
# CentOS/RHEL
sudo yum install -y perf

# Ubuntu/Debian
sudo apt-get install -y linux-tools-common linux-tools-generic

# å®‰è£…gitï¼ˆç”¨äºä¸‹è½½FlameGraphï¼‰
sudo yum install -y git  # æˆ– apt-get install -y git

# å®‰è£…perlï¼ˆè¿è¡ŒFlameGraphè„šæœ¬ï¼‰
sudo yum install -y perl  # æˆ– apt-get install -y perl
```

æ³¨ï¼šFlameGraphå·¥å…·ä¼šåœ¨é¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨ä¸‹è½½å®‰è£…

### ç¼–è¯‘å®‰è£…

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/sunyifei83/devops-toolkit.git
cd devops-toolkit

# 2. ç¼–è¯‘PerfSnapï¼ˆæ³¨æ„ï¼šéœ€è¦å•ç‹¬ç¼–è¯‘ï¼‰
go build -o perfsnap tools/go/PerfSnap.go

# 3. è®¾ç½®æ‰§è¡Œæƒé™
chmod +x perfsnap

# 4. (å¯é€‰) ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„
sudo mv perfsnap /usr/local/bin/

# 5. éªŒè¯å®‰è£…
perfsnap -version
```

## ä½¿ç”¨æ–¹æ³•

### åŸºç¡€ç”¨æ³•

```bash
# ç”Ÿæˆä¸€æ¬¡æ€§èƒ½å¿«ç…§æŠ¥å‘Š
sudo perfsnap

# å®æ—¶ç›‘æ§æ¨¡å¼ï¼ˆé»˜è®¤2ç§’åˆ·æ–°ï¼ŒæŒç»­60ç§’ï¼‰
sudo perfsnap -m

# è‡ªå®šä¹‰ç›‘æ§å‚æ•°
sudo perfsnap -m -interval 5 -duration 120  # æ¯5ç§’åˆ·æ–°ï¼ŒæŒç»­120ç§’

# æŸ¥çœ‹å¸®åŠ©
perfsnap -h
```

### ç«ç„°å›¾ç”Ÿæˆ

```bash
# è‡ªåŠ¨é€‰æ‹©CPUæœ€é«˜çš„è¿›ç¨‹ç”Ÿæˆç«ç„°å›¾
sudo perfsnap -flame

# æŒ‡å®šè¿›ç¨‹PIDç”Ÿæˆç«ç„°å›¾
sudo perfsnap -flame -pid 1234

# è‡ªå®šä¹‰é‡‡æ ·å‚æ•°
sudo perfsnap -flame -flame-duration 60 -flame-freq 99

# ç”Ÿæˆç«ç„°å›¾å¹¶è‡ªåŠ¨æ‰“å¼€
sudo perfsnap -flame -flame-open

# æŒ‡å®šè¾“å‡ºç›®å½•
sudo perfsnap -flame -flame-output /tmp/flamegraph

# å®Œæ•´ç¤ºä¾‹ï¼šç”Ÿæˆæ€§èƒ½æŠ¥å‘Š+ç«ç„°å›¾
sudo perfsnap -flame -flame-duration 30 -flame-open
```

### å‘½ä»¤è¡Œå‚æ•°

#### åŸºç¡€å‚æ•°
| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `-m, --monitor` | å®æ—¶ç›‘æ§æ¨¡å¼ | false |
| `-interval` | ç›‘æ§åˆ·æ–°é—´éš”(ç§’) | 2 |
| `-duration` | ç›‘æ§æŒç»­æ—¶é—´(ç§’) | 60 |
| `-h, --help` | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ | - |
| `-version` | æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ | - |

#### ç«ç„°å›¾å‚æ•°
| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `-flame` | ç”ŸæˆCPUç«ç„°å›¾ | false |
| `-pid` | æŒ‡å®šè¿›ç¨‹PID(0=è‡ªåŠ¨é€‰æ‹©) | 0 |
| `-flame-duration` | é‡‡æ ·æ—¶é•¿(ç§’) | 30 |
| `-flame-freq` | é‡‡æ ·é¢‘ç‡(Hz) | 99 |
| `-flame-output` | è¾“å‡ºç›®å½• | è‡ªåŠ¨ç”Ÿæˆ |
| `-flame-open` | è‡ªåŠ¨æ‰“å¼€ç«ç„°å›¾ | false |

## è¾“å‡ºç¤ºä¾‹

### æ€§èƒ½å¿«ç…§æŠ¥å‘Š

```
================================================================================
                    PerfSnap - ç³»ç»Ÿæ€§èƒ½å¿«ç…§åˆ†ææŠ¥å‘Š
                    2025-09-15 15:30:00
================================================================================

ã€ç³»ç»Ÿæ¦‚å†µã€‘
è¿è¡Œæ—¶é—´: 5 days | åœ¨çº¿ç”¨æˆ·: 2
ç³»ç»Ÿè´Ÿè½½: 0.52 (1åˆ†é’Ÿ) | 0.48 (5åˆ†é’Ÿ) | 0.45 (15åˆ†é’Ÿ)
CPUæ ¸å¿ƒæ•°: 8

ã€å†…å­˜çŠ¶æ€ã€‘
æ€»å†…å­˜: 16384 MB | å·²ä½¿ç”¨: 8192 MB (50.0%) | å¯ç”¨: 8192 MB
ç¼“å­˜: 4096 MB | ç¼“å†²: 512 MB

ã€CPUç»Ÿè®¡ã€‘
CPU    User%   System%  IOWait%   Idle%   çŠ¶æ€
------------------------------------------------------------
all      15.2      5.3      2.1     77.4   æ­£å¸¸
0        20.5      8.2      1.5     69.8   æ­£å¸¸
1        18.3      6.1      2.8     72.8   æ­£å¸¸
...

ã€ç£ç›˜IOç»Ÿè®¡ã€‘
è®¾å¤‡         è¯»IOPS   å†™IOPS    è¯»KB/s     å†™KB/s   é˜Ÿåˆ—   ä½¿ç”¨ç‡%
----------------------------------------------------------------------
sda            25.3     45.2      512.5     1024.8    1.2    15.5%
sdb            10.1     20.3      256.2      512.4    0.5     8.2%

ã€ç½‘ç»œæµé‡ã€‘
æ¥å£          æ¥æ”¶pps    å‘é€pps    æ¥æ”¶KB/s    å‘é€KB/s
------------------------------------------------------------
eth0           1250.5     1180.3       125.5       118.2
eth1            850.2      920.1        85.3        92.5

ã€TCPè¿æ¥ã€‘
å·²å»ºç«‹: 1250 | TIME_WAIT: 523 | CLOSE_WAIT: 12

ã€TOPè¿›ç¨‹ (æŒ‰CPUæ’åº)ã€‘
PID      ç”¨æˆ·          CPU%     å†…å­˜%   å‘½ä»¤
------------------------------------------------------------
12345    www          25.3      8.5    java
23456    mysql        18.2     15.3    mysqld
34567    root         12.5      2.1    nginx

ã€æ€§èƒ½åˆ†ææ€»ç»“ã€‘
------------------------------------------------------------
âœ… ç³»ç»Ÿæ€§èƒ½çŠ¶æ€è‰¯å¥½

ã€ä¼˜åŒ–å»ºè®®ã€‘
------------------------------------------------------------
â€¢ ç›‘æ§é«˜CPUè¿›ç¨‹java(PID:12345)çš„èµ„æºä½¿ç”¨æƒ…å†µ
```

### ç«ç„°å›¾è¾“å‡º

```
================================================================================
                    å¼€å§‹ç”Ÿæˆç«ç„°å›¾
================================================================================

è‡ªåŠ¨é€‰æ‹©CPUä½¿ç”¨ç‡æœ€é«˜çš„è¿›ç¨‹: PID=12345, Command=java, CPU=25.3%

å¼€å§‹ç”Ÿæˆç«ç„°å›¾...
ç›®æ ‡è¿›ç¨‹: PID=12345 (java)
é‡‡æ ·æ—¶é•¿: 30ç§’
é‡‡æ ·é¢‘ç‡: 99Hz
è¾“å‡ºç›®å½•: flamegraph_20250915_153000

[1/4] æ­£åœ¨é‡‡é›†æ€§èƒ½æ•°æ® (30ç§’)...
[2/4] æ­£åœ¨è§£æè°ƒç”¨æ ˆ...
[3/4] æ­£åœ¨æŠ˜å è°ƒç”¨æ ˆ...
[4/4] æ­£åœ¨ç”Ÿæˆç«ç„°å›¾...

âœ… ç«ç„°å›¾ç”ŸæˆæˆåŠŸ: flamegraph_20250915_153000/flamegraph_java_12345_20250915_153000.svg
æŸ¥çœ‹å™¨å·²ç”Ÿæˆ: flamegraph_20250915_153000/viewer_20250915_153000.html

ã€ç«ç„°å›¾åˆ†ææç¤ºã€‘
------------------------------------------------------------
1. æŸ¥çœ‹ç«ç„°å›¾: æ‰“å¼€ flamegraph_20250915_153000/viewer_20250915_153000.html
2. å®½åº¦è¶Šå®½çš„å‡½æ•°ï¼ŒCPUå ç”¨æ—¶é—´è¶Šé•¿
3. å¯»æ‰¾å¹³é¡¶ï¼ˆplateauï¼‰åŒºåŸŸï¼Œè¿™äº›å¯èƒ½æ˜¯æ€§èƒ½ç“¶é¢ˆ
4. å…³æ³¨é€’å½’è°ƒç”¨å’Œæ·±åº¦è°ƒç”¨æ ˆ
5. ä½¿ç”¨æµè§ˆå™¨çš„æœç´¢åŠŸèƒ½æŸ¥æ‰¾ç‰¹å®šå‡½æ•°
```
ç¤ºä¾‹ï¼š
./perfsnap_v1.1.0 -flame -pid 226594
![alt](/docs/img/ca5521a7059b.png)

## ç«ç„°å›¾åˆ†ææŒ‡å—

### ä»€ä¹ˆæ˜¯ç«ç„°å›¾

ç«ç„°å›¾ï¼ˆFlame Graphï¼‰æ˜¯ä¸€ç§æ€§èƒ½åˆ†æçš„å¯è§†åŒ–å·¥å…·ï¼Œç”¨äºå¿«é€Ÿè¯†åˆ«CPUçƒ­ç‚¹å‡½æ•°ã€‚

### å¦‚ä½•é˜…è¯»ç«ç„°å›¾

1. **Xè½´**ï¼šè¡¨ç¤ºé‡‡æ ·æ•°é‡çš„æ¯”ä¾‹ï¼Œè¶Šå®½çš„å‡½æ•°æ‰§è¡Œæ—¶é—´è¶Šé•¿
2. **Yè½´**ï¼šè¡¨ç¤ºè°ƒç”¨æ ˆæ·±åº¦ï¼Œä»ä¸‹åˆ°ä¸Šæ˜¯å‡½æ•°è°ƒç”¨å…³ç³»
3. **é¢œè‰²**ï¼šé€šå¸¸æ˜¯éšæœºçš„ï¼Œä»…ç”¨äºåŒºåˆ†ä¸åŒå‡½æ•°
4. **äº¤äº’**ï¼š
   - ç‚¹å‡»æŸä¸ªæ¡†å¯ä»¥æ”¾å¤§è¯¥éƒ¨åˆ†
   - Ctrl+Fæœç´¢ç‰¹å®šå‡½æ•°
   - ç‚¹å‡»ResetæŒ‰é’®é‡ç½®è§†å›¾

### æ€§èƒ½é—®é¢˜è¯†åˆ«

1. **å®½å¹³é¡¶**ï¼šå¯»æ‰¾å®½ä¸”å¹³çš„åŒºåŸŸï¼Œè¿™äº›é€šå¸¸æ˜¯æ€§èƒ½ç“¶é¢ˆ
2. **é«˜å¡”**ï¼šè¿‡æ·±çš„è°ƒç”¨æ ˆå¯èƒ½å­˜åœ¨é€’å½’æˆ–è®¾è®¡é—®é¢˜
3. **åˆ†æ•£**ï¼šè¿‡äºåˆ†æ•£çš„å°å—è¡¨ç¤ºCPUæ—¶é—´åˆ†æ•£ï¼Œæ²¡æœ‰æ˜æ˜¾çƒ­ç‚¹
4. **é›†ä¸­**ï¼šæŸä¸ªå‡½æ•°å æ®å¤§éƒ¨åˆ†å®½åº¦ï¼Œè¯´æ˜æ˜¯ä¸»è¦ç“¶é¢ˆ

### å¸¸è§æ¨¡å¼

- **CPUå¯†é›†å‹**ï¼šæŸäº›è®¡ç®—å‡½æ•°å æ®å¤§éƒ¨åˆ†å®½åº¦
- **é”ç«äº‰**ï¼šé”ç›¸å…³å‡½æ•°ï¼ˆå¦‚mutex_lockï¼‰å æ¯”è¾ƒé«˜
- **ç³»ç»Ÿè°ƒç”¨**ï¼šå¤§é‡æ—¶é—´èŠ±åœ¨ç³»ç»Ÿè°ƒç”¨ä¸Š
- **GCå‹åŠ›**ï¼šåƒåœ¾å›æ”¶ç›¸å…³å‡½æ•°å æ¯”é«˜ï¼ˆJava/Goç­‰ï¼‰

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **sysstatå·¥å…·æœªå®‰è£…**
   ```bash
   # é”™è¯¯: sar: command not found
   # è§£å†³:
   sudo yum install -y sysstat  # CentOS/RHEL
   sudo apt-get install -y sysstat  # Ubuntu/Debian
   ```

2. **æƒé™ä¸è¶³**
   ```bash
   # é”™è¯¯: éƒ¨åˆ†æ•°æ®æ— æ³•è·å–
   # è§£å†³: ä½¿ç”¨sudoè¿è¡Œ
   sudo perfsnap
   ```

3. **perfå·¥å…·æœªå®‰è£…**ï¼ˆç«ç„°å›¾åŠŸèƒ½ï¼‰
   ```bash
   # é”™è¯¯: perfå·¥å…·æœªå®‰è£…
   # è§£å†³:
   sudo yum install -y perf  # CentOS/RHEL
   sudo apt-get install -y linux-tools-common linux-tools-generic  # Ubuntu
   ```

4. **kernel.perf_event_paranoidé™åˆ¶**
   ```bash
   # é”™è¯¯: perf recordå¤±è´¥
   # è§£å†³: è°ƒæ•´å†…æ ¸å‚æ•°
   sudo sysctl -w kernel.perf_event_paranoid=-1
   ```

5. **FlameGraphä¸‹è½½å¤±è´¥**
   ```bash
   # é”™è¯¯: æ— æ³•å…‹éš†FlameGraph
   # è§£å†³: æ‰‹åŠ¨ä¸‹è½½
   cd ~
   git clone https://github.com/brendangregg/FlameGraph.git
   # æˆ–ä½¿ç”¨ä»£ç†
   git config --global http.proxy http://proxy:port
   ```

6. **ç¼–è¯‘é”™è¯¯**
   ```bash
   # é”™è¯¯: main redeclared in this block
   # è§£å†³: å•ç‹¬ç¼–è¯‘å„ä¸ªå·¥å…·
   go build -o perfsnap tools/go/PerfSnap.go
   go build -o nodeprobe tools/go/NodeProbe.go
   ```

## æœ€ä½³å®è·µ

### æ€§èƒ½åŸºçº¿å»ºç«‹
```bash
# åœ¨ç³»ç»Ÿæ­£å¸¸æ—¶å»ºç«‹åŸºçº¿
sudo perfsnap > baseline_$(date +%Y%m%d).txt

# å®šæœŸå¯¹æ¯”
sudo perfsnap > current.txt
diff baseline_*.txt current.txt
```

### é—®é¢˜è¯Šæ–­æµç¨‹
```bash
# 1. å¿«é€Ÿæ¦‚è§ˆ
sudo perfsnap | head -50

# 2. å¦‚å‘ç°CPUé—®é¢˜ï¼Œç”Ÿæˆç«ç„°å›¾
sudo perfsnap -flame -flame-duration 60

# 3. æŒç»­ç›‘æ§
sudo perfsnap -m -interval 1
