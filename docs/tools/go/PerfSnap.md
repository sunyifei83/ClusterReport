# PerfSnap - Linux系统性能快照分析工具

## 概述

`PerfSnap` 是一个专业的Linux系统性能快照分析工具，能够快速采集和分析系统的关键性能指标。该工具通过并发采集技术，在几秒内获取系统的CPU、内存、磁盘、网络等全方位性能数据，并生成易读的分析报告，帮助运维人员快速定位性能瓶颈。

**版本**: 1.0.0  
**作者**: sunyifei83@gmail.com  
**项目**: https://github.com/sunyifei83/devops-toolkit

## 核心特性

- ⚡ **快速采集**: 并发采集所有性能数据，几秒内完成全面分析
- 📊 **全面覆盖**: CPU、内存、磁盘I/O、网络、进程等多维度监控
- 🎯 **智能诊断**: 自动识别性能问题并提供优化建议
- 📈 **实时监控**: 支持实时监控模式，动态展示性能变化
- 🔍 **问题定位**: 快速定位高负载进程和系统瓶颈
- 📝 **清晰报告**: 格式化输出，易于阅读和分析

## 主要功能模块

### 1. 系统概况
- **运行时间**: 系统启动时长
- **系统负载**: 1分钟、5分钟、15分钟平均负载
- **在线用户**: 当前登录用户数
- **负载评估**: 自动评估负载是否过高

### 2. CPU性能分析
- **多核统计**: 每个CPU核心的使用率详情
- **性能指标**: 用户态、系统态、IO等待、空闲百分比
- **状态评估**: 自动识别CPU瓶颈
- **上下文切换**: 监控上下文切换频率

### 3. 内存管理
- **内存使用**: 总量、已用、可用、缓存、缓冲
- **交换分区**: Swap使用情况和告警
- **使用率分析**: 内存使用率百分比
- **内存压力**: 识别内存不足风险

### 4. 磁盘I/O
- **设备统计**: 所有活跃磁盘设备
- **IOPS指标**: 读写IOPS实时数据
- **吞吐量**: 读写KB/s速率
- **队列深度**: 平均队列长度
- **利用率**: 磁盘忙碌程度

### 5. 网络流量
- **接口统计**: 所有网络接口流量
- **包速率**: 收发包/秒
- **带宽使用**: 收发KB/秒
- **TCP连接**: 连接状态统计
- **异常检测**: TIME_WAIT过多告警

### 6. 进程分析
- **TOP进程**: CPU占用最高的进程
- **高负载进程**: CPU使用率>1%的进程列表
- **进程详情**: PID、用户、CPU%、内存%、命令

### 7. 系统日志
- **错误检测**: 最近1分钟的系统错误和警告
- **dmesg分析**: 内核日志异常信息

### 8. 性能诊断
- **自动诊断**: 识别系统性能问题
- **问题汇总**: 列出所有发现的问题
- **优化建议**: 针对性的优化方案

## 安装部署

### 依赖要求

#### 系统要求
- Linux操作系统（推荐CentOS 7+、Ubuntu 16.04+）
- Go 1.15或更高版本（编译时需要）

#### 必需软件包
```bash
# CentOS/RHEL
sudo yum install -y sysstat

# Ubuntu/Debian
sudo apt-get install -y sysstat

# 验证安装
which sar mpstat pidstat iostat vmstat
```

### 编译安装

```bash
# 1. 克隆项目
git clone https://github.com/sunyifei83/devops-toolkit.git
cd devops-toolkit/tools/go

# 2. 编译PerfSnap
go build -o perfsnap PerfSnap.go

# 3. 设置执行权限
chmod +x perfsnap

# 4. (可选) 移动到系统路径
sudo mv perfsnap /usr/local/bin/

# 5. 验证安装
perfsnap -h
```

## 使用方法

### 基本用法

```bash
# 生成性能快照报告（推荐使用root权限）
sudo perfsnap

# 查看帮助信息
perfsnap -h

# 实时监控模式（默认2秒间隔，持续60秒）
sudo perfsnap -m

# 自定义监控参数（5秒间隔，持续120秒）
sudo perfsnap -m 5 120
```

### 运行模式

#### 1. 快照模式（默认）
一次性采集当前系统性能数据并生成详细报告：
```bash
sudo perfsnap
```

#### 2. 监控模式
持续监控系统性能，实时刷新显示：
```bash
# 默认配置
sudo perfsnap -m

# 自定义间隔和持续时间
sudo perfsnap -m [间隔秒数] [持续秒数]
```

### 权限说明

虽然普通用户也可以运行PerfSnap，但建议使用root权限以获取完整数据：

- **普通用户**: 部分功能受限，如无法访问某些系统日志
- **Root权限**: 可获取所有性能数据，包括dmesg日志和详细进程信息

## 输出示例

### 快照报告示例

```
================================================================================
                    PerfSnap - 系统性能快照分析报告
                    2024-01-12 14:30:45
================================================================================

【系统概况】
运行时间: 5 days, 21:05 | 在线用户: 2
系统负载: 2.16 (1分钟) | 1.85 (5分钟) | 1.72 (15分钟)
CPU核心数: 8
⚠️  警告: 系统负载过高 (负载 2.16 > CPU核心数 8)

【内存状态】
总内存: 16384 MB | 已使用: 14745 MB (90.0%) | 可用: 1639 MB
缓存: 4096 MB | 缓冲: 512 MB
交换分区: 4096 MB | 已使用: 2048 MB (50.0%)
⚠️  警告: 交换分区使用率过高 (50.0%)

【CPU统计】
CPU      User%   System%  IOWait%    Idle%  状态
------------------------------------------------------------
ALL       45.2     12.3     30.5      12.0  ⚠️ IO等待高
cpu0      50.1     15.2     28.3       6.4  ⚠️ IO等待高
cpu1      42.3     11.5     32.1      14.1  ⚠️ IO等待高
...

【磁盘IO统计】
设备         读IOPS   写IOPS     读KB/s     写KB/s   队列  使用率%
----------------------------------------------------------------------
sda            125.3    245.8     1024.5     2048.3    4.2   95.3% ⚠️
sdb             45.2     85.6      512.3      768.4    1.5   45.2%

【网络流量】
接口         接收pps    发送pps     接收KB/s     发送KB/s
------------------------------------------------------------
eth0          1234.5     2345.6       567.8       890.1
eth1           123.4      234.5        56.7        89.0

【TCP连接】
已建立: 1523 | TIME_WAIT: 15234 | CLOSE_WAIT: 45
⚠️  警告: TIME_WAIT连接过多 (15234)

【性能分析总结】
------------------------------------------------------------
⚠️  发现以下性能问题:
  • 系统负载过高 (2.16)
  • IO等待过高 (30%)
  • 交换分区使用过多 (50.0%)
  • 磁盘 sda 利用率过高 (95.3%)
  • TIME_WAIT连接过多 (15234)

【优化建议】
------------------------------------------------------------
• IO等待过高: 检查磁盘性能，考虑使用SSD或优化IO密集型进程
• 系统负载过高: 检查CPU密集型进程，考虑增加CPU资源或优化代码
• 交换分区使用过多: 增加物理内存或调整swappiness参数
• TIME_WAIT过多: 优化TCP参数，如tcp_tw_reuse和tcp_tw_recycle

================================================================================
数据收集耗时: 2.35秒
```

### 实时监控示例

```
时间: 14:35:22 | 剩余: 55s
------------------------------------------------------------
负载: 1.52 1.68 1.71 | 内存: 85.3% | CPU: 用户25% 系统10% 空闲60% IO等待5%

磁盘IO:
  sda: 读125.3/s 写245.8/s 利用率85.3%
  sdb: 读45.2/s 写85.6/s 利用率35.2%

网络:
  eth0: ↓567.8KB/s ↑890.1KB/s
  eth1: ↓56.7KB/s ↑89.0KB/s

TOP进程 (CPU):
  12345 java CPU:45.2% MEM:32.1%
  23456 mysql CPU:25.3% MEM:28.5%
  34567 nginx CPU:12.5% MEM:5.2%
```

## 性能指标说明

### 关键阈值

| 指标 | 正常范围 | 警告阈值 | 说明 |
|------|---------|---------|------|
| 系统负载 | < CPU核心数 | > CPU核心数×1.5 | 负载过高影响响应时间 |
| CPU使用率 | < 80% | > 90% | CPU资源紧张 |
| IO等待 | < 20% | > 30% | 磁盘I/O瓶颈 |
| 内存使用率 | < 80% | > 90% | 内存不足风险 |
| Swap使用 | < 30% | > 50% | 内存压力大 |
| 磁盘利用率 | < 80% | > 90% | 磁盘I/O饱和 |
| 上下文切换 | < 50000/s | > 100000/s | 进程调度频繁 |
| TIME_WAIT | < 5000 | > 10000 | TCP连接积压 |

### 性能问题诊断

1. **高负载问题**
   - 检查CPU密集型进程
   - 查看是否有死循环或低效算法
   - 考虑负载均衡或增加服务器

2. **内存问题**
   - 检查内存泄漏
   - 优化应用内存使用
   - 调整系统缓存策略

3. **I/O瓶颈**
   - 使用SSD替代HDD
   - 优化数据库查询
   - 实施读写分离

4. **网络问题**
   - 检查网络带宽使用
   - 优化TCP参数
   - 实施连接池

## 最佳实践

### 日常巡检
```bash
# 每日定时执行性能快照
0 9,15,21 * * * /usr/local/bin/perfsnap >> /var/log/perfsnap/daily.log
```

### 故障诊断
```bash
# 问题发生时立即执行
sudo perfsnap > incident_$(date +%Y%m%d_%H%M%S).log

# 持续监控问题期间的性能
sudo perfsnap -m 1 300 > monitor_$(date +%Y%m%d_%H%M%S).log
```

### 性能基线
```bash
# 建立性能基线（系统空闲时）
sudo perfsnap > baseline.log

# 对比当前性能与基线
sudo perfsnap > current.log
diff baseline.log current.log
```

## 故障排查

### 常见问题

1. **"command not found: sar"**
   - 解决：安装sysstat包
   ```bash
   sudo yum install -y sysstat  # CentOS
   sudo apt-get install -y sysstat  # Ubuntu
   ```

2. **部分数据显示为空**
   - 原因：权限不足
   - 解决：使用sudo运行

3. **"vmstat: command not found"**
   - 解决：安装procps包
   ```bash
   sudo yum install -y procps  # CentOS
   sudo apt-get install -y procps  # Ubuntu
   ```

## 扩展开发

### 自定义阈值
可以修改源码中的阈值常量来适配特定环境：

```go
// 修改 PerfSnap.go 中的阈值
const (
    HIGH_LOAD_THRESHOLD = 1.5  // 负载阈值倍数
    HIGH_CPU_THRESHOLD = 90    // CPU使用率阈值
    HIGH_MEM_THRESHOLD = 90    // 内存使用率阈值
    HIGH_IOWAIT_THRESHOLD = 30 // IO等待阈值
)
```

### 添加监控指标
可以在源码中添加新的监控函数：

```go
// 添加自定义监控
func getCustomMetrics() CustomInfo {
    // 实现自定义指标采集
}
```

## 版本历史

- **v1.0.0** (2025-09-12)
  - 初始版本发布
  - 支持CPU、内存、磁盘、网络监控
