# iotest.sh - 磁盘I/O性能测试工具

## 概述

`iotest.sh` 是一个综合性的磁盘I/O性能测试脚本，主要用于评估服务器或系统的磁盘读写性能。该脚本使用 `fio` 工具进行随机读写混合测试，在 `fio` 不可用时会降级使用 `dd` 命令进行顺序读写测试。

## 主要功能

### 1. 系统环境检测
- **架构检测**：自动识别系统架构（x64、x86、aarch64、arm）
- **网络连接检测**：检查IPv4/IPv6连接状态
- **依赖检查**：检测系统中是否已安装 fio、iperf3、curl 等工具
- **空间检查**：确保有足够的磁盘空间进行测试（x64/x86需要2GB，ARM架构需要512MB）
- **ZFS文件系统检测**：特别处理ZFS文件系统的空间计算

### 2. 磁盘性能测试

#### FIO测试（主要方式）
- 使用 `fio` 工具进行随机读写混合测试
- 测试不同块大小：4k、64k、512k、1m
- 读写比例：50/50
- 测试参数：
  - I/O引擎：libaio
  - I/O深度：64
  - 并发任务：2
  - 运行时间：30秒
- 输出指标：
  - 读取速度（KB/s、MB/s或GB/s）
  - 写入速度（KB/s、MB/s或GB/s）
  - 读取IOPS
  - 写入IOPS
  - 总速度和总IOPS

#### DD测试（备用方式）
- 当 fio 不可用或测试失败时使用
- 执行3次测试取平均值
- 写测试：使用64k块大小，写入1GB数据
- 读测试：使用8k块大小，读取之前写入的数据
- 输出每次测试结果和平均值

## 关键函数说明

### `format_speed()`
将原始的KB/s速度格式化为更易读的单位（GB/s、MB/s或KB/s）

### `format_iops()`
格式化IOPS值，当大于1000时转换为k单位

### `disk_test()`
执行fio磁盘性能测试的主函数

### `dd_test()`
执行dd备用磁盘测试的函数

### `catch_abort()`
捕获CTRL+C信号，清理临时文件并退出

## 使用方法

```bash
# 直接运行脚本
./iotest.sh

# 或使用bash运行
bash iotest.sh
```

## 输出示例

### FIO测试输出
```
Block Size | 4k         (IOPS)   | 64k        (IOPS)
  ------   | ---        ----     | ----       ----
Read       | 45.2 MB/s  (11.3k)  | 285.4 MB/s (4.5k)
Write      | 45.1 MB/s  (11.2k)  | 284.9 MB/s (4.4k)
Total      | 90.3 MB/s  (22.5k)  | 570.3 MB/s (8.9k)

Block Size | 512k       (IOPS)   | 1m         (IOPS)
  ------   | ---        ----     | ----       ----
Read       | 412.8 MB/s (806)    | 425.1 MB/s (415)
Write      | 413.2 MB/s (807)    | 424.9 MB/s (414)
Total      | 826.0 MB/s (1.6k)   | 850.0 MB/s (829)
```

### DD测试输出
```
dd Sequential Disk Speed Tests:
---------------------------------
       | Test 1      | Test 2      | Test 3      | Avg
-------+-------------+-------------+-------------+---------
Write  | 523 MB/s    | 518 MB/s    | 521 MB/s    | 520.67 MB/s
Read   | 612 MB/s    | 608 MB/s    | 615 MB/s    | 611.67 MB/s
```

## 注意事项

1. **权限要求**：脚本需要在具有写权限的目录中运行
2. **空间要求**：
   - x64/x86架构：至少需要2GB可用空间
   - ARM架构：至少需要512MB可用空间
3. **临时文件**：脚本会创建临时目录存储测试文件，测试完成后自动清理
4. **ZFS文件系统**：在ZFS文件系统上运行时，需要更多的可用空间（通常是2倍的spa_asize_inflation值）
5. **区域设置**：脚本会临时设置LC_ALL=C以确保输出格式的一致性

## 依赖项

### 必需
- bash shell
- 基本的Unix工具（df、awk、grep、sed等）

### 可选（优先使用）
- `fio`：高性能I/O测试工具（推荐）
- `curl` 或 `wget`：用于下载fio二进制文件

### 备用
- `dd`：当fio不可用时使用的基础磁盘测试工具

## 兼容性

- **支持的架构**：
  - x86_64 (x64)
  - i386/i686 (x86)
  - aarch64 (ARM 64-bit)
  - arm (ARM 32-bit) - 实验性支持
- **操作系统**：Linux、Unix-like系统
- **文件系统**：支持所有主流文件系统，包括ext4、xfs、btrfs、zfs等

## 故障排查

1. **"You do not have write permission"错误**
   - 切换到有写权限的目录后重新运行

2. **"Less than 2GB of space available"警告**
   - 清理磁盘空间或在有足够空间的分区运行

3. **FIO测试失败自动切换到DD测试**
   - 可能是fio下载失败或系统不兼容
   - 检查网络连接或手动安装fio

4. **ZFS文件系统警告**
   - 确保有足够的可用空间（通常需要4GB以上）

## 脚本来源

该脚本基于 YABS (Yet Another Bench Script) 项目的磁盘测试部分，原项目地址：
https://github.com/masonr/yet-another-bench-script

## 使用场景

- 服务器性能基准测试
- 存储系统性能评估
- 磁盘升级前后的性能对比
- 故障诊断和性能调优
- 云服务器磁盘性能验证
